/*
 Dialogr v0.1.0
 (c) 2016 dlid.se. http://docs.dlid.se/dialogr
 License: MIT
*/
(function(w){function H(a){I++;return("0000"+(Math.random()*Math.pow(36,4)<<0).toString(36)).slice(-4)+I}function J(a,c,d,b){function e(a,c){v(h[a])&&(h[a]=[]);h[a].push(c)}function k(a,c,b,d,k){var f="undefined"!==typeof d&&null!=d;b=z({await:null,messageId:null},b||{});b.messageId||(g++,b.messageId=l+"_"+g);var e="mother",h=["dialogr.close","dialogr.block","dialogr.unblock","dialogr.open"];if(f)e="custom target window";else if(null!==t)if(t.child)-1===h.indexOf(a)&&(e="father");else if(!t.mother&&
t.father&&-1!==h.indexOf(a))e="mother";else if(t.mother||t.father)e="dialog";a={direction:m,source:"dialogr",messageType:a,messageData:c,messageId:b.messageId,dialogrId:k?k:n,await:b.await,fromLocation:w.location.href};d=f?d:u[e];"undefined"===typeof d||null==d?console.error("Target window was null or undefined",e):d.postMessage(JSON.stringify(a),"*")}function f(c){if(c.source!=window){var b;try{b=JSON.parse(c.data)}catch(d){}if(b&&!v(b.source)&&"dialogr"===b.source){if(!n){if(-1===b.messageType.indexOf("dialogr.find-opener"))return}else if(n!==
b.dialogrId)return;if(v(h[b.messageType]))b.await&&(console.warn("no handlers in",a,h,window.location),k(b.messageId+"_response",{type:"fail",response:["Nothing listening for '"+b.messageType+"'"]},null,c.source));else if(b.await)for(var e=function(a){g++;"fail"===a.type&&(t=!1);m.push(a);g===f.length&&(clearTimeout(u),k(b.messageId+"_response",{type:t?"success":"fail",response:m},null,c.source))},f=h[b.messageType].slice(0),g=0,m=[],u=null,t=!0,u=setTimeout(function(){k(b.messageId+"_response",{type:"fail",
response:["Operation took too long > "+b.await+"ms"]},null,c.source)},b.await),l=0;l<f.length;l++){if(p=f[l](b.messageData,b,c),b.await)if(p&&p.done&&p.fail&&p.promise)p.then(function(a){u&&e({index:l,type:"success",data:a})},function(a){u&&e({index:l,type:"fail",data:a})});else{if(!u)break;e({apa:3,index:l,type:"success",data:p})}}else for(var l=0;l<h[b.messageType].length;l++)var p=h[b.messageType][l](b.messageData,b,c)}}}var g=0,l=H("m"),h={},n=null,m="",t=null,u={mother:c||null,father:c||null,
child:null};D(window,"message",f);m=null==c?"opener=>dialog":"dialog=>opener";return{send:k,await:function(a,b,c,d,f){var m=x.Deferred();c=z({await:5E3},c||{});g++;c.messageId=a+"://await"+l+g;e(c.messageId+"_response",function(a,b,c){for(var d=[],e=0;e<a.response.length;e++)"string"===typeof a.response[e]?d.push(a.response[e]):a.response[e].data&&d.push(a.response[e].data);b={messageEvent:c,message:b};"fail"===a.type?m.rejectWith(b,[1==d.length?d[0]:d]):m.resolveWith(b,[1==d.length?d[0]:d])});k(a,
b,c,d,f);return m.promise()},setDialogrId:function(a){n=a},setTargetWindow:function(a){},setEventingTargetWindow:function(a){},setNamedTarget:function(a,b){"father"==a&&(t.fatherIdentified=!0);u[a]=b},on:e,off:function(a,b){return this},handleMessage:f,$$eventHandlers:h,setIdentity:function(a){t=a}}}function O(a,c,d,b){var e,k=q.slice(0);if(E)e=new K(a,c,{},!0),E.invoke("dialogr.open",{optionsOrUrl:a,options:c,newDialogId:e.id,openerId:L}).then(function(a){e.$$e.setDialogrId(e.id);e.$$e.setTargetWindow(w);
e.$$e.setNamedTarget("mother",this.messageEvent.source)});else{if(0<k.length){for(var f=0,g=0;g<k.length;g++){var l=p(r(k[g].$$el.dialog,"z-index"));l>f&&(f=l)}c.zIndex=f+10}e=new K(a,c,{},d,b)}return e}function v(a){return"undefined"===typeof a}function D(a,c,d){null==a||v(a)||(a.addEventListener?a.addEventListener(c,d,!1):a.attachEvent?a.attachEvent("on"+c,d):a["on"+c]=d)}function p(a){a=parseInt(a,10);return isNaN(a)?0:a}function y(a,c){return{t:p(r(a,c+"-top")),r:p(r(a,c+"-right")),b:p(r(a,c+
"-bottom")),l:p(r(a,c+"-left"))}}function r(a,c){if(window.getComputedStyle)var d=document.defaultView.getComputedStyle(a,null).getPropertyValue(c);else a.currentStyle&&(d=a.currentStyle[c]);return d}function F(a,c){var d;"function"===typeof a&&(a=a(c));if("string"===typeof a)if(d=a.match(/^(\d+)\%$/))a=Math.ceil(d[1]/100*c)+"px";else{if(d=a.match(/^(\d+)$/))a=parseInt(d[1],10)+"px"}else a="number"===typeof a?a+"px":0;return a}function P(a,c,d){var b=new J(null,a,!0),e=this;b.await("dialogr.find-opener",
{dialogUrl:window.location.toString()},null,a).then(function(a){var d={child:!0,motherIdentified:!0,fatherIdentified:!0,childId:a.dialogrId};e.param=a.param||{};L=a.dialogrId;b.setDialogrId(a.dialogrId);if(a.opener){d.fatherIdentified=!1;b.setIdentity(d);b.on("dialogr.i-am-your-father",function(a,d,f){b.off("dialogr.i-am-your-father");b.setNamedTarget("father",f.source);e.unblock();c(a)});for(var d=w.parent,g=0;g<d.window.frames.length;g++)b.send("dialogr.find-father",{frame:g,childId:a.dialogrId},
null,d.window.frames[g])}else b.setIdentity(d),e.unblock(),c(a)},function(a){d(a)});this.$$e=b;this.$$w=a;this.on=function(a,c){b.on(a,c);return e};this.invoke=function(c,d){return b.await(c,d,null,a)};this.trigger=function(c,d){return b.send(c,d,null,a)};this.close=function(){b.send("dialogr.close")};this.block=function(){b.send("dialogr.block")};this.unblock=function(){b.send("dialogr.unblock")};this.resolve=function(a){b.send("dialogr.resolve",a)};this.reject=function(a){b.send("dialogr.reject",
a)};this.param={}}function Q(){var a=x.Deferred();G.done(function(){E=new P(w.parent,function(c){a.resolve(E)},function(c){a.reject(c)})});return a.promise()}function A(a){function c(){d=y(a,"padding");b=y(a,"border-width");e=y(a,"margin");k="border-box"===r(a,"box-sizing");n="block"===r(a,"display");k?(l=p(r(a,"width")),h=p(r(a,"height")),f=l-d.l-d.r-e.l-e.r-b.l-b.r,g=h-d.t-d.b-e.t-e.b-b.t-b.b):(l=p(r(a,"width"))+d.l+d.r+e.l+e.r+b.l+b.r,h=p(r(a,"height"))+d.t+d.b+e.t+e.b+b.t+b.b,f=p(r(a,"width")),
g=p(r(a,"height")))}var d,b,e,k,f,g,l,h,n;c();return{width:function(){return n?l:0},height:function(){return n?h:0},innerWidth:function(){return f},innerHeight:function(){return g},padding:d,border:b,margin:e,setWidth:function(f){f=k?p(f):p(f)-d.l-d.r-e.l-e.r-b.l-b.r;a.style.width=f+"px";c()},setHeight:function(f){f=k?p(f):p(f)-d.t-d.b-e.t-e.b-b.t-b.b;a.style.height=f+"px";c()},setTop:function(b){b=p(b);a.style.top=b+"px"},setLeft:function(b){b=p(b);a.style.left=b+"px"}}}function R(a,c,d){for(var b=
0;b<q.length;b++)if(q[b].id==a){q[b].trigger(c,d);break}}function S(a,c,d,b){for(var e=0;e<q.length;e++)if(q[e].id==a){q[e].triggerAs(c,d,b);break}}function T(a){for(var c=0;c<q.length;c++)if(q[c].id==a)return q[c].close()}function U(a,c,d,b){for(var e=0;e<q.length;e++)if(q[e].id==a)return q[e].invokeAs(c,d,b)}function V(a,c,d){for(var b=0;b<q.length;b++)if(q[b].id==a)return q[b].invoke(c,d)}function K(a,c,d,b,e){function k(){M(g,f)}var f,g={},l=this,h=null;if("string"===typeof a){if(v(c)||"object"!==
typeof c)c={};c.url=a}else"object"===typeof a&&(c=a);f=z({},W,c);f.maxWidth=F(f.maxWidth,window.outerWidth);f.minWidth=F(f.minWidth,window.outerWidth);if(v(f.url))console.error("[dialogr] No url was given");else{a=!1;b&&!0!==b?this.id=b:(N++,this.id="d"+H("dlg")+"_"+N);!0===b&&(a=!0);h={father:!1,mother:!1,child:!1};!0===b?(h.father=!0,h.fatherTo=this.id):v(b)?(h.mother=!0,h.motherTo=this.id,h.father=!0,h.fatherTo=this.id):(h.mother=!0,h.motherTo=this.id);var n=x.Deferred(),m=new J(this.id,null,a,
e);m.setIdentity(h);if(h.father)m.on("dialogr.find-father",function(a,b,c){h.fatherTo==a.childId&&(m.setNamedTarget("child",c.source),m.send("dialogr.i-am-your-father",{fatherLocation:w.location.href},null,c.source))});m.on("dialogr.find-opener",function(a,b,c){m.off("dialogr.find-opener");a=x.Deferred();m.setDialogrId(l.id);m.setNamedTarget("dialog",c.source);a.resolve(z({openerUrl:window.location.href.toString(),dialogrId:l.id,param:f.param},{opener:e}));return a.promise()});m.on("dialogr.reject",
function(a){n.reject(a);l.close()});m.on("dialogr.resolve",function(a){n.resolve(a);l.close()});m.on("dialogr.close",function(a,b,c){l.close()});m.on("dialogr.block",function(){g.loaderOverlay.style.visibility="visible"});m.on("dialogr.unblock",function(){g.loaderOverlay.style.visibility="hidden";g.content.style.visibility="visible"});if(!b||b&&!0!==b)m.on("dialogr.open",function(a){var b=x.Deferred();dialogr.open(a.optionsOrUrl,a.options,a.newDialogId,a.openerId);b.resolve({dialogrId:a.newDialogId});
return b.promise()}),g=X(this.id,f),g.addToDom(),setTimeout(function(){M(g,f)},5),D(window,"resize",k),g.content.setAttribute("src",f.url);this.$$e=m;this.$$el=g;this.block=function(){};this.unblock=function(){};this.close=function(){if(h.father&&!h.mother)m.send("dialogr.close");else if(h.mother){for(var a=0;a<q.length;a++)if(q[a].id==l.id){q.splice(a,1);break}g&&g.dialog&&g.dialog.parentNode&&g.overlay&&(g.dialog.parentNode.removeChild(g.dialog),g.overlay.parentNode.removeChild(g.overlay))}};this.always=
n.then;this.done=n.done;this.fail=n.fail;this.then=function(a){n.then(a);return l};this.invokeAs=function(a,b,c){return m.await(a,b,null,null,c)};this.triggerAs=function(a,b,c){m.send(a,b,null,null,c)};this.trigger=function(a,b){m.send(a,b);return l};this.invoke=function(a,b){return m.await(a,b)};this.on=function(a,b){m.on(a,b);return l};q.push(this)}}function M(a,c){var d,b,e,k,f=a.dialog,g=a.loaderOverlay,l=a.content,h=a.footer,n=a.loader,m=a.header;d=F(c.width,window.innerWidth);b=F(c.height,window.innerHeight);
e=Math.ceil(window.innerWidth/2-parseInt(d,10)/2)+"px";k=Math.ceil(window.innerHeight/2-parseInt(b,10)/2)+"px";var t=d,u=y(a.dialog,"padding"),B=y(a.dialog,"border-width"),C=y(a.dialog,"margin");0<p(c.maxWidth)&&p(t)>parseInt(c.maxWidth)&&(d=c.maxWidth,e=Math.ceil(window.innerWidth/2-parseInt(d,10)/2)+"px",r(a.dialog,"box-sizing"),p(d));"border-box"!=r(a.dialog,"box-sizing")&&(d=p(d)-u.l-u.r-B.l-B.r-C.l-C.r+"px",b=p(b)-u.t-u.b-B.t-B.b-C.t-C.b+"px");if(p(t)>window.innerWidth||0<p(c.minWidth)&&p(window.innerWidth)<
p(c.minWidth))d=window.innerWidth+"px",b=window.innerHeight+"px",k=e="0px";r(a.dialog,"box-sizing");p(d);f.style.width=d;f.style.height=b;f.style.left=e;f.style.top=k;g.style.width=d;g.style.height=b;g.style.left=e;g.style.top=k;f=A(f);m=A(m);l=A(l);h=A(h);n=A(n);l.setWidth(f.innerWidth());f.innerHeight();h.height();m.height();l.setHeight(f.innerHeight()-h.height()-m.height());h.setTop(l.height()+m.height());h.setWidth(f.innerWidth());n.setTop(f.innerHeight()/2-n.height()/2);n.setLeft(f.innerWidth()/
2-n.width()/2)}function X(a,c){var d,b,e,k,f,g,l;d=document.createElement("div");d.setAttribute("class",c.className);d.style.position="fixed";d.style.zIndex=c.zIndex;d.style.display="block";b=document.createElement("div");b.setAttribute("data-dialogr-id",a);b.setAttribute("class",c.className+"__overlay");b.style.position="fixed";b.style.width="100%";b.style.backgroundColor="rgba(0,0,0,0.5)";b.style.height="100%";b.style.top="0";b.style.left="0";b.style.zIndex=d.style.zIndex-10;e=document.createElement("iframe");
e.setAttribute("class",c.className+"__content");e.style.position="absolute";e.style.display="block";e.style.visibility="hidden";k=document.createElement("div");k.setAttribute("class",c.className+"__loader-overlay");k.style.position="fixed";k.style.border="1px solid #aaa";k.style.backgroundColor="rgba(255,255,255,0.8)";k.style.cursor="wait";k.style.display="block";f=document.createElement("div");f.setAttribute("class",c.className+"__overlay");f.style.position="absolute";f.style.backgroundColor="#fff";
k.style.visibility="visible";k.style.display="block";f.innerHTML="Loading...";f.style.display="block";g=document.createElement("div");g.setAttribute("class",c.className+"__footer");g.style.position="absolute";g.style.display="block";l=document.createElement("div");l.setAttribute("class",c.className+"__header");l.style.overflow="hidden";l.style.display="block";var h=0;if(!v(c.buttons))if(c.buttons.constructor===Array)for(var n=0;n<c.buttons.length;n++)g.innerHTML+="<button  onclick='javascript:dialogr.trigger(\""+
a+'", "button_'+n+"\")' class='dialogr__button'>"+c.buttons[n]+"</button>",h++;else if("object"===typeof c.buttons)for(n in c.buttons)c.buttons.hasOwnProperty(n)&&(g.innerHTML+="<button onclick='javascript:dialogr.trigger(\""+a+'", "button_'+n+"\")' class='dialogr__button' >"+c.buttons[n].text+"</button>",h++);0==h&&(g.style.display="none");c.title?l.innerHTML="<a href='javascript:dialogr.close(\""+a+"\")'>x</a><h1>"+c.title+"</h1>":l.style.display="none";d.appendChild(l);d.appendChild(e);d.appendChild(g);
k.appendChild(f);d.appendChild(k);return{overlay:b,loaderOverlay:k,loader:f,dialog:d,header:l,footer:g,content:e,destroy:function(){},addToDom:function(){document.body.appendChild(d);document.body.appendChild(b)}}}function z(a){Array.prototype.slice.call(arguments,1).forEach(function(c){if(c)for(var d in c)null===c[d]||"undefined"===typeof c[d]?delete a[d]:c[d].constructor===Object?a[d]&&a[d].constructor!==Object?a[d]=c[d]:(a[d]=a[d]||{},z(a[d],c[d])):a[d]=c[d]});return a}var W={zIndex:1500,url:null,
className:"dialogr",width:"90%",height:"60%",title:null,buttons:["Ok","Cancel"],init:function(a){var c=document.createElement("div");c.style.backgroundColor="yellow";c.innerHTML="<p>hejsan alla glada</p>";a.parentNode.appendChild(c)},param:null,maxWidth:null,minWidth:600},I=0,G,N=null,x=this;D(w,"keydown",function(a){});var E=null,L=null,q=[];(function(a){function c(a){return"[object Array]"===Object.prototype.toString.call(a)}function d(a,b){if(c(a))for(var d=0;d<a.length;d++)b(a[d]);else b(a)}function b(a){var k=
"pending",f=[],g=[],l=[],h=null,n={done:function(){for(var a=0;a<arguments.length;a++)if(arguments[a])if(c(arguments[a]))for(var b=arguments[a],d=0;d<b.length;d++)"resolved"===k&&b[d].apply(this,h),f.push(b[d]);else"resolved"===k&&arguments[a].apply(this,h),f.push(arguments[a]);return this},fail:function(){for(var a=0;a<arguments.length;a++)if(arguments[a])if(c(arguments[a]))for(var b=arguments[a],d=0;d<b.length;d++)"rejected"===k&&b[d].apply(this,h),g.push(b[d]);else"rejected"===k&&arguments[a].apply(this,
h),g.push(arguments[a]);return this},always:function(){return this.done.apply(this,arguments).fail.apply(this,arguments)},progress:function(){for(var a=0;a<arguments.length;a++)if(arguments[a])if(c(arguments[a]))for(var b=arguments[a],d=0;d<b.length;d++)"pending"===k&&l.push(b[d]);else"pending"===k&&l.push(arguments[a]);return this},then:function(){1<arguments.length&&arguments[1]&&this.fail(arguments[1]);0<arguments.length&&arguments[0]&&this.done(arguments[0]);2<arguments.length&&arguments[2]&&
this.progress(arguments[2])},promise:function(a){if(null==a)return n;for(var b in n)a[b]=n[b];return a},state:function(){return k},debug:function(){console.log("[debug]",f,g,k)},isRejected:function(){return"rejected"===k},isResolved:function(){return"resolved"===k},pipe:function(a,c,e){return b(function(b){d(a,function(a){"function"===typeof a?m.done(function(){var c=a.apply(this,arguments);c&&"function"===typeof c?c.promise().then(b.resolve,b.reject,b.notify):b.resolve(c)}):m.done(b.resolve)});d(c,
function(a){"function"===typeof a?m.fail(function(){var c=a.apply(this,arguments);c&&"function"===typeof c?c.promise().then(b.resolve,b.reject,b.notify):b.reject(c)}):m.fail(b.reject)})}).promise()}},m={resolveWith:function(a){if("pending"===k){k="resolved";for(var b=h=1<arguments.length?arguments[1]:[],c=0;c<f.length;c++)f[c].apply(a,b)}return this},rejectWith:function(a){if("pending"===k){k="rejected";for(var b=h=1<arguments.length?arguments[1]:[],c=0;c<g.length;c++)g[c].apply(a,b)}return this},
notifyWith:function(a){if("pending"===k)for(var b=h=1<arguments.length?arguments[1]:[],c=0;c<l.length;c++)l[c].apply(a,b);return this},resolve:function(){return this.resolveWith(this,arguments)},reject:function(){return this.rejectWith(this,arguments)},notify:function(){return this.notifyWith(this,arguments)}},p=n.promise(m);a&&a.apply(p,[p]);return p}b.when=function(){if(2>arguments.length){var a=arguments.length?arguments[0]:void 0;return a&&"function"===typeof a.isResolved&&"function"===typeof a.isRejected?
a.promise():b().resolve(a).promise()}return function(a){for(var c=b(),d=a.length,e=0,h=Array(d),n=0;n<a.length;n++)(function(b){var n=null;a[b].done?a[b].done(function(){h[b]=2>arguments.length?arguments[0]:arguments;++e==d&&c.resolve.apply(c,h)}).fail(function(){c.reject(arguments)}):(n=a[b],a[b]=new Deferred,a[b].done(function(){h[b]=2>arguments.length?arguments[0]:arguments;++e==d&&c.resolve.apply(c,h)}).fail(function(){c.reject(arguments)}).resolve(n))})(n);return c.promise()}(arguments)};a.Deferred=
b})(this);G=this.Deferred();"complete"===document.readyState?G.resolve():D(window,"load",function(){G.resolve()});w.dialogr=function(){return{open:O,ready:Q,close:T,trigger:R,invoke:V,triggerAs:S,invokeAs:U,deferred:function(){return x.Deferred()}}}()})(window);